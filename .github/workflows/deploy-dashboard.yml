name: Deploy Grafana Dashboard

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    services:
      prometheus:
        image: prom/prometheus:latest
        ports:
          - 9090:9090
        # Mount the Prometheus config file (create this file first!)
        volumes:
          - ${{ github.workspace }}/prometheus.yml:/etc/prometheus/prometheus.yml

      node-exporter:
        image: prom/node-exporter:latest
        ports:
          - 9100:9100

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Download and Extract grafanactl
      run: |
        curl -L -o grafanactl-x86_64.tar.gz "https://github.com/grafana/grafanactl/releases/download/${{ vars.GRAFANACTL_VERSION }}/grafanactl_Linux_x86_64.tar.gz"
        tar -xzf grafanactl-x86_64.tar.gz
        chmod +x grafanactl
        sudo mv grafanactl /usr/local/bin/grafanactl

    - name: Generate Dashboard JSON
      working-directory: ${{ github.workspace }}
      run: |
        echo "Building and running Java class with Gradle..."
        
        # 1. Make gradlew executable
        chmod +x gradlew
        
        # 2. Execute the Main class using a Gradle task
        # We assume you will add a Gradle task to run your Main class (see Fix 2).
        ./gradlew runGenerateDashboard
        
        # Verification (Optional but Recommended)
        if [ ! -f ./src/main/resources/dashboard.json ]; then
          echo "ERROR: Dashboard JSON was not generated at ./src/main/resources/dashboard.json"
          exit 1
        else
          echo ./src/main/resources/dashboard.json
        fi

    - name: Deploy Dashboard with grafanactl
      env:
        GRAFANA_SERVER: ${{ vars.GRAFANA_SERVER }}
        GRAFANA_STACK_ID: ${{ vars.GRAFANA_STACK_ID }}
        GRAFANA_TOKEN: ${{ secrets.GRAFANA_TOKEN }}
        DASHBOARD_PATH: ./src/main/resources/dashboard.json
        # REMOVE the working-directory line entirely.
      run: |
        if [ -f ${{ env.DASHBOARD_PATH }} ]; then
          echo "dashboard.json exists, deploying grafana dashboard."
          grafanactl resources push dashboards --path ${{ env.DASHBOARD_PATH }} 
        else
          echo "ERROR: Dashboard JSON was not generated at ${{ env.DASHBOARD_PATH }}"
          exit 1
        fi
      working-directory: ${{ github.workspace }}